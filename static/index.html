<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatbot Tin t·ª©c T√†i ch√≠nh</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 0; 
      background: #0b1220; 
      color: #e6edf3; 
    }
    
    header { 
      padding: 16px 24px; 
      background: #0f1629; 
      border-bottom: 1px solid #1f2a44;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 { 
      margin: 0; 
      font-size: 18px; 
    }
    
    #clearBtn {
      background: transparent;
      border: 1px solid #374151;
      color: #9ca3af;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    #clearBtn:hover {
      background: #1f2937;
      color: #e5e7eb;
    }
    
    #container { 
      display: flex; 
      flex-direction: column; 
      height: calc(100vh - 60px); 
      max-width: 1200px;
      margin: 0 auto;
    }
    
    #messages { 
      flex: 1; 
      overflow-y: auto; 
      padding: 16px; 
      display: flex; 
      flex-direction: column; 
      gap: 16px;
      scroll-behavior: smooth;
    }
    
    .msg { 
      padding: 12px 16px; 
      border-radius: 12px; 
      max-width: 85%; 
      line-height: 1.6;
      position: relative;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user { 
      align-self: flex-end; 
      background: #1e40af;
      color: white;
    }
    
    .assistant { 
      align-self: flex-start; 
      background: #1f2937;
      border: 1px solid #374151;
    }
    
    .msg-header {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .copy-btn {
      background: transparent;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .copy-btn:hover {
      background: #374151;
      color: #d1d5db;
    }
    
    <!-- .msg-content {
      white-space: pre-wrap;
      word-wrap: break-word;
    } -->
    .msg-content {
      white-space: normal;
      word-wrap: break-word;
    }

    .msg-content ul {
      margin: 6px 0;
      padding-left: 20px;
    }

    .msg-content li {
      margin: 4px 0;
    }

    .msg-content strong {
      font-weight: 600;
      color: #60a5fa;
    }
    
    .msg-content ul, .msg-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    .sources {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #374151;
    }
    
    .sources-title {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .source-item {
      background: #111827;
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .source-item a {
      color: #60a5fa;
      text-decoration: none;
    }
    
    .source-item a:hover {
      text-decoration: underline;
    }
    
    .source-date {
      color: #6b7280;
      font-size: 11px;
      margin-left: 8px;
    }
    
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 12px;
      max-width: 70px;
      align-self: flex-start;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: #6b7280;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    
    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    
    .welcome-message h2 {
      font-size: 24px;
      margin: 0 0 16px 0;
      color: #e5e7eb;
    }
    
    .welcome-message p {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .example-queries {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .example-query {
      background: #1f2937;
      border: 1px solid #374151;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .example-query:hover {
      background: #374151;
      border-color: #4b5563;
    }
    
    #inputBar { 
      display: flex; 
      gap: 8px; 
      padding: 12px; 
      border-top: 1px solid #1f2a44; 
      background: #0f1629;
    }
    
    #messageInput { 
      flex: 1; 
      padding: 10px 12px; 
      border-radius: 10px; 
      border: 1px solid #24314f; 
      background: #0b1220; 
      color: #e6edf3;
      resize: none;
      font-family: inherit;
      font-size: 14px;
      min-height: 44px;
      max-height: 120px;
    }
    
    #messageInput:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    #charCount {
      position: absolute;
      right: 70px;
      bottom: 20px;
      font-size: 11px;
      color: #6b7280;
    }
    
    #charCount.warning {
      color: #f59e0b;
    }
    
    #charCount.error {
      color: #ef4444;
    }
    
    button { 
      padding: 10px 20px; 
      border-radius: 10px; 
      background: #3b82f6; 
      border: none; 
      color: white; 
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #2563eb;
    }
    
    button:disabled { 
      background: #1e3a8a; 
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
      }
      
      h1 {
        font-size: 16px;
      }
      
      #messages {
        padding: 12px;
      }
      
      .msg {
        max-width: 90%;
      }
      
      #inputBar {
        padding: 8px;
      }
      
      .example-queries {
        flex-direction: column;
      }
      
      .example-query {
        width: 100%;
        text-align: center;
      }
    }
    
    /* Scrollbar styling */
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    
    #messages::-webkit-scrollbar-track {
      background: #0b1220;
    }
    
    #messages::-webkit-scrollbar-thumb {
      background: #1f2937;
      border-radius: 4px;
    }
    
    #messages::-webkit-scrollbar-thumb:hover {
      background: #374151;
    }
  </style>
</head>
<body>
  <header>
    <h1>üíº Chatbot Tin t·ª©c T√†i ch√≠nh</h1>
    <button id="clearBtn" onclick="clearChat()">üóëÔ∏è X√≥a chat</button>
  </header>
  
  <div id="container">
    <div id="messages">
      <div class="welcome-message" id="welcomeMsg">
        <h2>üëã Xin ch√†o!</h2>
        <p>T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√≥m t·∫Øt v√† ph√¢n t√≠ch tin t·ª©c t√†i ch√≠nh Vi·ªát Nam.</p>
        <div class="example-queries">
          <div class="example-query" onclick="useExample(this)">T√¨nh h√¨nh l∆∞∆°ng t·∫°i Vi·ªát Nam nh∆∞ th·∫ø n√†o?</div>
          <div class="example-query" onclick="useExample(this)">Ng√†nh n√†o c√≥ m·ª©c tƒÉng l∆∞∆°ng cao nh·∫•t?</div>
          <div class="example-query" onclick="useExample(this)">Doanh nghi·ªáp c√≥ k·∫ø ho·∫°ch tuy·ªÉn d·ª•ng kh√¥ng?</div>
        </div>
      </div>
    </div>
    
    <div id="inputBar" style="position: relative;">
      <textarea 
        id="messageInput" 
        placeholder="H·ªèi v·ªÅ tin t·ª©c t√†i ch√≠nh..." 
        maxlength="2000"
      ></textarea>
      <span id="charCount">0/2000</span>
      <button id="sendBtn" onclick="sendMessage()">G·ª≠i</button>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const MAX_LENGTH = 2000;
    
    // Session management
    function ensureSessionId() {
      let id = localStorage.getItem('session_id');
      if (!id) {
        id = crypto.randomUUID ? crypto.randomUUID() : `session_${Date.now()}`;
        localStorage.setItem('session_id', id);
      }
      return id;
    }
    
    // Main send function
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;
      if (text.length > MAX_LENGTH) {
        alert(`Tin nh·∫Øn qu√° d√†i! T·ªëi ƒëa ${MAX_LENGTH} k√Ω t·ª±.`);
        return;
      }
      
      // Hide welcome message
      const welcomeMsg = document.getElementById('welcomeMsg');
      if (welcomeMsg) welcomeMsg.remove();
      
      // Append user message
      appendMessage(text, 'user');
      input.value = '';
      updateCharCount();
      setLoading(true);
      
      // Show typing indicator
      const typingId = showTypingIndicator();
      
      const sessionId = ensureSessionId();
      
      try {
        const res = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            session_id: sessionId, 
            message: text,
            return_sources: true  // Request sources
          })
        });
        
        removeTypingIndicator(typingId);
        
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || err.detail || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        
        if (data.success) {
          appendMessage(data.answer || 'Kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi', 'assistant', data.sources);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
        
      } catch (e) {
        removeTypingIndicator(typingId);
        appendMessage(`‚ùå L·ªói: ${e.message}`, 'assistant');
      } finally {
        setLoading(false);
      }
    }
    
    // Append message to chat
    function appendMessage(text, role, sources = null) {
      const wrap = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      
      // Add header with copy button
      const header = document.createElement('div');
      header.className = 'msg-header';
      header.innerHTML = `
        <span>${role === 'user' ? 'B·∫°n' : 'Tr·ª£ l√Ω AI'}</span>
        <button class="copy-btn" onclick="copyMessage(this)">üìã Copy</button>
      `;
      div.appendChild(header);
      
      // Add content with basic markdown parsing
      const content = document.createElement('div');
      content.className = 'msg-content';
      content.innerHTML = parseMarkdown(text);
      div.appendChild(content);
      
      // Add sources if available
      if (sources && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'sources';
        sourcesDiv.innerHTML = `
          <div class="sources-title">üìö Ngu·ªìn tham kh·∫£o:</div>
          ${sources.map(src => `
            <div class="source-item">
              <a href="${src.url}" target="_blank">${src.title}</a>
              <span class="source-date">${formatDate(src.date)}</span>
            </div>
          `).join('')}
        `;
        div.appendChild(sourcesDiv);
      }
      
      wrap.appendChild(div);
      wrap.scrollTop = wrap.scrollHeight;
    }
    
    // Simple markdown parser
    function parseMarkdown(text) {
      // Escape HTML tr∆∞·ªõc ƒë·ªÉ tr√°nh l·ªói v·ª° layout
      text = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      // Bold
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

      // X·ª≠ l√Ω bullet chu·∫©n: gom to√†n b·ªô "- xxx" th√†nh <ul>
      const lines = text.split("\n");
      let inList = false;
      let result = [];

      for (let line of lines) {
        const match = line.match(/^- (.+)/);

        if (match) {
          if (!inList) {
            inList = true;
            result.push("<ul>");
          }
          result.push(`<li>${match[1]}</li>`);
        } else {
          if (inList) {
            result.push("</ul>");
            inList = false;
          }
          result.push(line);
        }
      }

      if (inList) result.push("</ul>");

      return result.join("\n");
    }

    
    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('vi-VN', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric' 
        });
      } catch {
        return dateStr;
      }
    }
    
    // Copy message
    function copyMessage(btn) {
      const msgContent = btn.closest('.msg').querySelector('.msg-content');
      const text = msgContent.textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '‚úì Copied';
        setTimeout(() => {
          btn.textContent = 'üìã Copy';
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
      });
    }
    
    // Typing indicator
    let typingCounter = 0;
    function showTypingIndicator() {
      const wrap = document.getElementById('messages');
      const div = document.createElement('div');
      const id = `typing_${typingCounter++}`;
      div.id = id;
      div.className = 'typing-indicator';
      div.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;
      wrap.appendChild(div);
      wrap.scrollTop = wrap.scrollHeight;
      return id;
    }
    
    function removeTypingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }
    
    // Loading state
    function setLoading(loading) {
      const btn = document.getElementById('sendBtn');
      const input = document.getElementById('messageInput');
      btn.disabled = loading;
      input.disabled = loading;
      btn.textContent = loading ? 'ƒêang x·ª≠ l√Ω...' : 'G·ª≠i';
    }
    
    // Clear chat
    async function clearChat() {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ chat?')) return;
      
      const sessionId = localStorage.getItem('session_id');
      if (sessionId) {
        try {
          await fetch(`${API_BASE}/api/session/${sessionId}`, {
            method: 'DELETE'
          });
        } catch (e) {
          console.error('Failed to clear session:', e);
        }
      }
      
      // Clear UI
      document.getElementById('messages').innerHTML = `
        <div class="welcome-message" id="welcomeMsg">
          <h2>üëã Xin ch√†o!</h2>
          <p>T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√≥m t·∫Øt v√† ph√¢n t√≠ch tin t·ª©c t√†i ch√≠nh Vi·ªát Nam.</p>
          <div class="example-queries">
            <div class="example-query" onclick="useExample(this)">T√¨nh h√¨nh l∆∞∆°ng t·∫°i Vi·ªát Nam nh∆∞ th·∫ø n√†o?</div>
            <div class="example-query" onclick="useExample(this)">Ng√†nh n√†o c√≥ m·ª©c tƒÉng l∆∞∆°ng cao nh·∫•t?</div>
            <div class="example-query" onclick="useExample(this)">Doanh nghi·ªáp c√≥ k·∫ø ho·∫°ch tuy·ªÉn d·ª•ng kh√¥ng?</div>
          </div>
        </div>
      `;
    }
    
    // Use example query
    function useExample(el) {
      const input = document.getElementById('messageInput');
      input.value = el.textContent;
      input.focus();
      updateCharCount();
    }
    
    // Auto-resize textarea
    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }
    
    // Update character count
    function updateCharCount() {
      const input = document.getElementById('messageInput');
      const counter = document.getElementById('charCount');
      const len = input.value.length;
      counter.textContent = `${len}/${MAX_LENGTH}`;
      
      counter.className = '';
      if (len > MAX_LENGTH * 0.9) counter.className = 'warning';
      if (len >= MAX_LENGTH) counter.className = 'error';
    }
    
    // Event listeners
    window.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('messageInput');
      
      // Enter to send
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Auto-resize and char count
      input.addEventListener('input', (e) => {
        autoResize(e.target);
        updateCharCount();
      });
      
      // Initial resize
      autoResize(input);
    });
  </script>
</body>
</html>